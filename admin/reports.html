<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Ghar ka Parishkar</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .sidebar {
            width: 250px;
            background-color: var(--color-bg-dark);
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding: var(--spacing-xl);
        }

        .sidebar h3 {
            color: white;
            margin-bottom: var(--spacing-xl);
        }

        .main-content {
            margin-left: 250px;
            padding: var(--spacing-2xl);
        }

        .nav-link {
            display: block;
            color: rgba(255, 255, 255, 0.7);
            padding: var(--spacing-md) 0;
            text-decoration: none;
            transition: color 0.3s;
        }

        .nav-link:hover,
        .nav-link.active {
            color: white;
        }

        .upload-section {
            background: white;
            padding: var(--spacing-2xl);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-2xl);
        }

        .upload-area {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-2xl);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: var(--color-primary);
            background: #e9ecef;
        }

        .upload-area.dragover {
            border-color: var(--color-primary);
            background: #e3f2fd;
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
        }

        .table-container {
            background: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.95rem;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        tr:hover {
            background-color: #f1f5f9;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }

        .btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-sm {
            padding: 4px 12px;
            font-size: 0.85rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: var(--spacing-md);
            display: none;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--color-primary);
            transition: width 0.3s;
        }

        .file-info {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: #f0f9ff;
            border-radius: var(--radius-sm);
            display: none;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-pdf {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-excel {
            background: #dcfce7;
            color: #166534;
        }

        .badge-word {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-image {
            background: #fef3c7;
            color: #92400e;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <h3>Admin Panel</h3>
        <nav style="margin-top: var(--spacing-2xl);">
            <a href="dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="enquiry.html" class="nav-link"><i class="fas fa-question-circle"></i> Enquiries</a>
            <a href="#" class="nav-link"><i class="fas fa-users"></i> Users</a>
            <a href="reports.html" class="nav-link active"><i class="fas fa-file-alt"></i> Reports</a>
            <a href="settings.html" class="nav-link"><i class="fas fa-cog"></i> Settings</a>
            <a href="../index.html" class="nav-link" style="margin-top: var(--spacing-2xl); color: #ff6b7a;"><i
                    class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </div>

    <div class="main-content">
        <h1 style="margin-bottom: var(--spacing-xl);">Inspection Reports</h1>

        <!-- Upload Section -->
        <div class="upload-section">
            <h2 style="margin-bottom: var(--spacing-lg);">Upload New Report</h2>

            <form id="uploadForm">
                <div class="grid grid-2" style="margin-bottom: var(--spacing-lg);">
                    <div class="form-group">
                        <label for="clientName">Client Name *</label>
                        <input type="text" id="clientName" required placeholder="Enter client name">
                    </div>
                    <div class="form-group">
                        <label for="inspectionDate">Inspection Date *</label>
                        <input type="date" id="inspectionDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="propertyAddress">Property Address *</label>
                    <input type="text" id="propertyAddress" required placeholder="Enter property address">
                </div>

                <div class="form-group">
                    <label for="reportName">Report Name *</label>
                    <input type="text" id="reportName" required placeholder="e.g., Home Inspection - 123 Main St">
                </div>

                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"
                        style="font-size: 3rem; color: var(--color-primary); margin-bottom: var(--spacing-md);"></i>
                    <p style="font-size: 1.1rem; margin-bottom: var(--spacing-sm);">Drag & Drop your file here</p>
                    <p style="color: #64748b; margin-bottom: var(--spacing-md);">or</p>
                    <button type="button" class="btn btn-primary"
                        onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> Browse Files
                    </button>
                    <input type="file" id="fileInput" style="display: none;"
                        accept=".pdf,.xlsx,.xls,.docx,.doc,.jpg,.jpeg,.png">
                    <p style="color: #64748b; margin-top: var(--spacing-md); font-size: 0.9rem;">
                        Supported: PDF, Excel, Word, Images (Max 10MB)
                    </p>
                </div>

                <div class="file-info" id="fileInfo">
                    <p><strong>Selected File:</strong> <span id="fileName"></span></p>
                    <p><strong>File Size:</strong> <span id="fileSize"></span></p>
                </div>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-bar-fill" id="progressBarFill"></div>
                </div>

                <button type="submit" class="btn btn-success" style="margin-top: var(--spacing-lg); width: 100%;">
                    <i class="fas fa-upload"></i> Upload Report
                </button>
            </form>
        </div>

        <!-- Reports Table -->
        <div class="section">
            <h2 style="margin-bottom: var(--spacing-lg);">Uploaded Reports</h2>

            <div class="table-container">
                <table id="reportsTable">
                    <thead>
                        <tr>
                            <th>Report Name</th>
                            <th>Client Name</th>
                            <th>Inspection Date</th>
                            <th>Property Address</th>
                            <th>File Type</th>
                            <th>Upload Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be populated by JS -->
                    </tbody>
                </table>
                <div id="emptyState" class="empty-state">
                    <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>No reports uploaded yet</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { storage, db } from '../js/firebase-config.js';
        import { ref, uploadBytesResumable, getDownloadURL, deleteObject } from 'firebase/storage';
        import { collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, query, orderBy } from 'firebase/firestore';

        let selectedFile = null;

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const uploadForm = document.getElementById('uploadForm');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            // Validate file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                return;
            }

            selectedFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }

        function getFileBadgeClass(extension) {
            if (extension === 'pdf') return 'badge-pdf';
            if (['xlsx', 'xls'].includes(extension)) return 'badge-excel';
            if (['docx', 'doc'].includes(extension)) return 'badge-word';
            if (['jpg', 'jpeg', 'png'].includes(extension)) return 'badge-image';
            return 'badge-pdf';
        }

        // Upload form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedFile) {
                alert('Please select a file to upload');
                return;
            }

            const clientName = document.getElementById('clientName').value;
            const inspectionDate = document.getElementById('inspectionDate').value;
            const propertyAddress = document.getElementById('propertyAddress').value;
            const reportName = document.getElementById('reportName').value;

            try {
                // Show progress bar
                const progressBar = document.getElementById('progressBar');
                const progressBarFill = document.getElementById('progressBarFill');
                progressBar.style.display = 'block';

                // Create unique filename
                const timestamp = Date.now();
                const fileExtension = getFileExtension(selectedFile.name);
                const fileName = `report_${timestamp}.${fileExtension}`;
                const filePath = `reports/${fileName}`;

                // Upload to Firebase Storage
                const storageRef = ref(storage, filePath);
                const uploadTask = uploadBytesResumable(storageRef, selectedFile);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBarFill.style.width = progress + '%';
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        alert('Upload failed: ' + error.message);
                        progressBar.style.display = 'none';
                    },
                    async () => {
                        // Upload completed successfully
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);

                        // Save metadata to Firestore
                        await addDoc(collection(db, 'inspection_reports'), {
                            reportName: reportName,
                            clientName: clientName,
                            inspectionDate: inspectionDate,
                            propertyAddress: propertyAddress,
                            fileType: fileExtension,
                            fileName: selectedFile.name,
                            fileUrl: downloadURL,
                            filePath: filePath,
                            fileSize: selectedFile.size,
                            uploadedAt: serverTimestamp()
                        });

                        // Reset form
                        uploadForm.reset();
                        selectedFile = null;
                        fileInfo.style.display = 'none';
                        progressBar.style.display = 'none';
                        progressBarFill.style.width = '0%';

                        alert('Report uploaded successfully!');
                        loadReports();
                    }
                );
            } catch (error) {
                console.error('Error uploading report:', error);
                alert('Error uploading report: ' + error.message);
            }
        });

        // Load reports from Firestore
        async function loadReports() {
            const tbody = document.querySelector('#reportsTable tbody');
            const emptyState = document.getElementById('emptyState');

            tbody.innerHTML = '';

            try {
                const q = query(collection(db, 'inspection_reports'), orderBy('uploadedAt', 'desc'));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    emptyState.style.display = 'block';
                    return;
                } else {
                    emptyState.style.display = 'none';
                }

                querySnapshot.forEach((docSnapshot) => {
                    const report = docSnapshot.data();
                    const tr = document.createElement('tr');

                    const uploadDate = report.uploadedAt ? new Date(report.uploadedAt.toDate()).toLocaleDateString() : 'N/A';
                    const badgeClass = getFileBadgeClass(report.fileType);

                    tr.innerHTML = `
                        <td><strong>${report.reportName}</strong></td>
                        <td>${report.clientName}</td>
                        <td>${report.inspectionDate}</td>
                        <td>${report.propertyAddress}</td>
                        <td><span class="badge ${badgeClass}">${report.fileType.toUpperCase()}</span></td>
                        <td>${uploadDate}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="downloadReport('${report.fileUrl}', '${report.fileName}')">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteReport('${docSnapshot.id}', '${report.filePath}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Error loading reports:', error);
                alert('Error loading reports: ' + error.message);
            }
        }

        // Download report
        window.downloadReport = function (fileUrl, fileName) {
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = fileName;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Delete report
        window.deleteReport = async function (reportId, filePath) {
            if (!confirm('Are you sure you want to delete this report?')) {
                return;
            }

            try {
                // Delete from Storage
                const storageRef = ref(storage, filePath);
                await deleteObject(storageRef);

                // Delete from Firestore
                await deleteDoc(doc(db, 'inspection_reports', reportId));

                alert('Report deleted successfully!');
                loadReports();
            } catch (error) {
                console.error('Error deleting report:', error);
                alert('Error deleting report: ' + error.message);
            }
        };

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadReports();
        });
    </script>
</body>

</html>